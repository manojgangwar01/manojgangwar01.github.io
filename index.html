<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>Street Fault Notification</title>
  <link rel="stylesheet" href="https://js.arcgis.com/3.25/dijit/themes/claro/claro.css" />
  <link rel="stylesheet" href="https://js.arcgis.com/3.25/esri/css/esri.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open Sans">

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<style>
    html, 
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      margin: 0;
      font-family: "Open Sans";
    }

    #leftPane {
      width: 20%;
      margin: 0;
      border: none;
    }

    #map {
      padding: 0;
    }

    .nav {
      padding: 5px 10px;
      border: solid 1px grey;
    }

    #header {
      text-align: center;
      height: 60px;
      border-bottom: solid 1px #ccc;
    }
  </style>

  <script src="https://js.arcgis.com/3.25/"></script>
  <script>
	var lat,lng;
	function getLocation() 
	{
		if (navigator.geolocation) 
		{
			navigator.geolocation.getCurrentPosition(setPosition);
		} 
		else 
		{
			console.log("Geolocation is not supported by this browser.");
		}
	}

	function setPosition(position) 
	{
		lat=position.coords.latitude;
		lng=position.coords.longitude;
		console.log("lat:"+lat);
		console.log("log:"+lng);
	}
	
    require([
      "dojo/ready", "dojo/on", "dojo/dom", "dijit/registry", "dojo/dom-construct", "dojo/parser", "dijit/layout/BorderContainer", "dijit/layout/ContentPane", "esri/map", "esri/arcgis/utils", "esri/domUtils", "esri/dijit/Popup", "esri/layers/FeatureLayer", "esri/InfoTemplate"
    ], function (
      ready, on, dom, registry, domConstruct, parser, BorderContainer, ContentPane, Map, arcgisUtils, domUtils, Popup, FeatureLayer, InfoTemplate
    ) {
        ready(function () {

          parser.parse();

          //setup event handlers for the next/previous buttons
          on(dom.byId("previous"), "click", selectPrevious);
          on(dom.byId("next"), "click", selectNext);

          //Create a map based on an ArcGIS Online web map id 
                  arcgisUtils.createMap("fd288e1aff2745178e55353caf34d29b", "map")
                    .then(function(response) {
                      window.map = response.map;
                      //set the popup's popupWindow property to false. This prevents the popup from displaying
                      map.infoWindow.set("popupWindow", false);
                      initializeSidebar(window.map);
                    }, function(error) {
                      console.log("Map creation failed: ", dojo.toJson(error));
                    });

          map.on('load', initializeSidebar());

          function initializeSidebar() {
            //alert("in side bar");
            var popup = map.infoWindow;

            //when the selection changes update the side panel to display the popup info for the 
            //currently selected feature. 
            popup.on("selection-change", function () {
              displayPopupContent(popup.getSelectedFeature());
            });

            //when the selection is cleared remove the popup content from the side panel. 
            popup.on("clear-features", function () {
              //dom.byId replaces dojo.byId
//              dom.byId("featureCount").innerHTML = "Click to select feature";
              //registry.byId replaces dijit.byId
              registry.byId("leftPane").set("content", "");
//              domUtils.hide(dom.byId("pager"));
            });

            //When features are associated with the map's info window update the sidebar with the new content. 
            popup.on("set-features", function () {
//              displayPopupContent(popup.getSelectedFeature());
              if (popup.features.length > 1) {
//                dom.byId("featureCount").innerHTML = popup.features.length + " features selected";
                //enable navigation if more than one feature is selected 
//                domUtils.show(dom.byId("pager"))
              } else {
//                dom.byId("featureCount").innerHTML = popup.features.length + " feature selected";
//                domUtils.hide(dom.byId("pager"));
              }
            });
			
			getLocation();
          }

          function displayPopupContent(feature) {
            if (feature) {
              var content = feature.getContent();
              registry.byId("leftPane").set("content", content);
//			  alert(content.innerHTML);
				var popup_html=content.innerHTML;
				var frm123_html="";
				var frm123_url="";
				var inc_1=9;
				for (var i = 0; i < popup_html.length; i++) 
				{
//				  console.log(str.charAt(i));
//console.log(popup_html.substring(i,inc_1+i));
					if (popup_html.substring(i,inc_1+i)=='<a href="')
					{
						frm123_html='<a href="';
						i=i+inc_1;
						for (;i < popup_html.length; i++) 
						{
							if(popup_html.charAt(i)=='"')
							{
								break;
							}
							frm123_html=frm123_html+popup_html.charAt(i);
							frm123_url=frm123_url+popup_html.charAt(i);
						}
						frm123_html=frm123_html.replace(/amp;/g, '')
						frm123_url=frm123_url.replace(/amp;/g, '')
						frm123_html=frm123_html+"\" target=\"survey123frm\" onclick=\"document.getElementById('survey123div').innerHTML='';\"> Open form </a>";
					}
				}
				if((frm123_html.trim()).length>0)
				{
//					document.getElementById("survey123div").innerHTML=frm123_html;
					document.getElementById("survey123div").innerHTML="";
				}
				else
				{
					document.getElementById("survey123div").innerHTML="Street light already reported to Network. <br>Please select another street light to report on.";
				}
				document.getElementById("survey123frm").src="blank.html";
				document.getElementById("survey123frm").src=frm123_url;
              registry.byId("leftPane").set("content", "");
            }
          }

          function selectPrevious() {
            map.infoWindow.selectPrevious();
          }

          function selectNext() {
            map.infoWindow.selectNext();
          }
		  
			
        });
      });

	function refresh_map() 
	{
		setInterval(function()
			{ 
	//			map.getLayer("a1ed4a71a6044abe8d81b44fc4d14f0c").refresh(); 
			}, 10000);  // refresh every 10 seconds
	}	

 </script>

 <style>
.embed-container {position: relative; width:70%; min-width:400px; height:30%; min-height:400px} 
.embed-container iframe, .embed-container object, .embed-container iframe{position: absolute; top: 0; left: 0; width: 100%; height: 100%;} small{position: absolute; z-index: 40; bottom: 0; margin-bottom: -15px;}
</style>
 
</head>

<body class="claro" style="font-family:verdana">
  <div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutters:false" style="width:100%; height:700px;">
    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left'" style="width: 30%;height:100%;"></div>
    <div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:false" region="center" >
      <div id="leftPane" style="display:none;" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'"></div>
      <div id="header" style="display:none;" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
        <div id="featureCount" style="display:none;" style="margin-bottom:5px;">Click to select feature</div>
        <div id="pager" style="display:none;">
          <a href='javascript:void(0);' id="previous" class='nav' style="text-decoration: none;">
            &lt; Prev
          </a> &nbsp;
          <a href='javascript:void(0);' id="next" class='nav' style="text-decoration: none;">
            Next &gt;
          </a>
        </div>
      </div>
		  <div id="survey123div" style="font-size:13px;">
			Select faulty street light from the MAP..
		  </div>
			<iframe style="width:90%;min-width:400px; height:100%;" frameborder="0" name="survey123frm" id="survey123frm" src="blank.html">
			</iframe>
    </div>
  </div>
<div style="font-size:10px;">
	Map will auto-refresh every 1 min...
	<div>
	<font color="red">RED</font>: Street light is reported to Network<br>
	<font color="green">GREEN</font>: Street light in working status
	</div>
</div>
<div style="font-size:13px;">
	Currently, only two councils (Parramatta & Camden) are used for this demo.
</div>
<br>
<br>
<div style="font-size:13px;">
	This functionality is achieved using ArcGIS and Survey123 form. ArcGIS map is using overlaying FeatureLayers (Street light map and Survey123 result map) for displaying the Street light in EE network and reported fault. 
</div>
 
</body>

</html>